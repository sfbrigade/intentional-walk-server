version: 2.1

orbs:
  docker: circleci/docker@2.2.0

jobs:
  build-and-test:
    docker:
      - image: cimg/base:edge
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true 
      - run:
          name: Copy example.env to .env
          command: |
            cp example.env .env      
      - run:
          name: Run Docker image
          command: |
            docker-compose -p iwalk -f docker-compose.yml -f docker-compose.override.yml up -d
      - run:
          name: Check Poetry
          command: |
            docker-compose -p iwalk exec server bash -c "poetry check -vvv"
      - run:
          name: Check code formatting with Black
          command: |
            docker-compose -p iwalk exec server bash -c "black --check ."
      - run:
          name: Lint code with Flake8
          command: |
            docker exec server bash -c "poetry run flake8 --count ."
      - run:
          name: Run Pytest, report coverage
          # make test and make coverage are redundant,
          # but make coverage actually doesn't fail the build if it fails; it just reports a lower
          # coverage percentage for failing short, but "succeeds"
          command: |
            docker exec server bash -c "
              make test
              make coverage
              poetry run coveralls
            "
workflows:
  main:
    jobs:
      - build-and-test
